name: Deploy Appraisal Management Platform

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ACR_NAME: ${{ secrets.ACR_NAME }}
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  CONTAINER_APP_NAME: ${{ secrets.CONTAINER_APP_NAME }}
  NODE_VERSION: '18.x'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Type check
      run: npm run type-check

    - name: Lint code
      run: npm run lint

    - name: Run unit tests
      run: npm run test:unit

    - name: Build application
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  build-container:
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Build and push to ACR
      run: |
        az acr build \
          --registry ${{ env.ACR_NAME }} \
          --image appraisal-backend:${{ github.sha }} \
          --image appraisal-backend:latest \
          .

  deploy-infrastructure:
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    needs: [build-and-test]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy infrastructure
      run: |
        az deployment sub create \
          --location eastus \
          --template-file infrastructure/main-production-parameterized.bicep \
          --parameters \
            location=eastus \
            environment=prod \
            appName=appraisal-mgmt \
            tags='{"project":"appraisal-management","environment":"production","deployedBy":"github-actions"}' \
          --name "appraisal-deployment-${{ github.sha }}"

  deploy-application:
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    needs: [build-container, deploy-infrastructure]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Update Container App
      run: |
        az containerapp update \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/appraisal-backend:${{ github.sha }} \
          --revision-suffix ${{ github.sha }}

    - name: Wait for deployment
      run: |
        echo "Waiting for Container App to be ready..."
        sleep 30

    - name: Health check
      run: |
        APP_URL=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "properties.configuration.ingress.fqdn" -o tsv)
        
        echo "Testing application health at https://$APP_URL"
        
        # Wait for app to be fully ready
        for i in {1..10}; do
          if curl -f "https://$APP_URL/health/ready"; then
            echo "Application is ready!"
            break
          fi
          echo "Attempt $i: Application not ready yet, waiting..."
          sleep 30
        done
        
        # Final health check
        curl -f "https://$APP_URL/health" || exit 1

  integration-tests:
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    needs: [deploy-application]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get application URL
      id: get-url
      run: |
        APP_URL=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "properties.configuration.ingress.fqdn" -o tsv)
        echo "app-url=https://$APP_URL" >> $GITHUB_OUTPUT

    - name: Run integration tests
      env:
        API_BASE_URL: ${{ steps.get-url.outputs.app-url }}
      run: |
        echo "Running integration tests against $API_BASE_URL"
        npm run test:integration:production

    - name: Test API endpoints
      env:
        API_BASE_URL: ${{ steps.get-url.outputs.app-url }}
      run: |
        echo "Testing key API endpoints..."
        curl -f "$API_BASE_URL/health" || exit 1
        curl -f "$API_BASE_URL/api" || exit 1
        curl -f "$API_BASE_URL/api/property-intelligence/health" || exit 1