name: Deploy to Azure

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      
  workflow_dispatch:
    inputs:
      environment:
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        description: 'Target environment'
        default: 'dev'
      deploy_infrastructure:
        required: false
        type: boolean
        description: 'Deploy infrastructure (uncheck for application-only deployment)'
        default: true

env:
  NODE_VERSION: '18.x'

jobs:
  determine-environment:
    name: Determine Target Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      deploy-infrastructure: ${{ steps.env.outputs.deploy-infrastructure }}
    
    steps:
    - name: Determine environment
      id: env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          echo "deploy-infrastructure=${{ github.event.inputs.deploy_infrastructure }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "environment=dev" >> $GITHUB_OUTPUT
          echo "deploy-infrastructure=true" >> $GITHUB_OUTPUT
        else
          echo "environment=dev" >> $GITHUB_OUTPUT
          echo "deploy-infrastructure=false" >> $GITHUB_OUTPUT
        fi
        
        echo "üéØ Target environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d'=' -f2)"
        echo "üèóÔ∏è Deploy infrastructure: $(cat $GITHUB_OUTPUT | grep deploy-infrastructure | cut -d'=' -f2)"

  continuous-integration:
    name: Continuous Integration
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: [determine-environment, continuous-integration]
    if: needs.determine-environment.outputs.deploy-infrastructure == 'true'
    uses: ./.github/workflows/infrastructure.yml
    with:
      environment: ${{ needs.determine-environment.outputs.environment }}
      location: 'eastus2'
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  deploy-application:
    name: Deploy Application
    needs: [determine-environment, continuous-integration, deploy-infrastructure]
    if: always() && needs.continuous-integration.result == 'success' && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped')
    uses: ./.github/workflows/application.yml
    with:
      environment: ${{ needs.determine-environment.outputs.environment }}
      app-service-name: ${{ needs.deploy-infrastructure.outputs.app-service-name || format('appraisal-mgmt-{0}-app', needs.determine-environment.outputs.environment) }}
      app-service-url: ${{ needs.deploy-infrastructure.outputs.app-service-url || format('https://appraisal-mgmt-{0}-app.azurewebsites.net', needs.determine-environment.outputs.environment) }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

  production-promotion:
    name: Production Promotion
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-application]
    if: needs.determine-environment.outputs.environment == 'staging' && needs.deploy-application.result == 'success'
    environment: production-approval
    
    steps:
    - name: Manual approval for production
      run: |
        echo "üö® Production deployment requires manual approval"
        echo "Staging deployment completed successfully"
        echo "Ready to promote to production?"
        
    - name: Trigger production deployment
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'deploy.yml',
            ref: 'main',
            inputs: {
              environment: 'prod',
              deploy_infrastructure: 'true'
            }
          });

  post-deployment:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-application]
    if: always() && needs.deploy-application.result == 'success'
    
    steps:
    - name: Update README badges
      run: |
        echo "üìù Updating deployment status badges..."
        # This would update badges in README.md or create deployment artifacts
        
    - name: Notify stakeholders
      run: |
        echo "üì¢ Notifying stakeholders of successful deployment..."
        echo "Environment: ${{ needs.determine-environment.outputs.environment }}"
        echo "Status: SUCCESS"
        
    - name: Create GitHub release
      if: needs.determine-environment.outputs.environment == 'prod'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: "v1.0.0-${{ github.sha }}"
        release_name: "Production Release v1.0.0-${{ github.sha }}"
        body: |
          ## üöÄ Production Deployment
          
          Successfully deployed to production environment.
          
          ### Changes
          - Latest changes from main branch
          - Infrastructure and application updates
          
          ### Verification
          - ‚úÖ Health checks passed
          - ‚úÖ Integration tests passed
          - ‚úÖ Performance tests passed
          
          ### Links
          - [Application URL](https://appraisal-mgmt-prod-app.azurewebsites.net)
          - [Health Check](https://appraisal-mgmt-prod-app.azurewebsites.net/health)
        draft: false
        prerelease: false

  failure-notification:
    name: Failure Notification
    runs-on: ubuntu-latest
    needs: [continuous-integration, deploy-infrastructure, deploy-application]
    if: always() && (needs.continuous-integration.result == 'failure' || needs.deploy-infrastructure.result == 'failure' || needs.deploy-application.result == 'failure')
    
    steps:
    - name: Notify Teams on deployment failure
      uses: jdcargile/ms-teams-notification@v1.3
      with:
        github-token: ${{ github.token }}
        ms-teams-webhook-uri: ${{ secrets.MS_TEAMS_WEBHOOK_URI }}
        notification-summary: "‚ùå Deployment failed for ${{ github.repository }}"
        notification-color: danger
        timezone: America/New_York
        
    - name: Create incident issue
      uses: actions/github-script@v7
      with:
        script: |
          const title = `üö® Deployment Failure - ${new Date().toISOString()}`;
          const body = `
          ## Deployment Failure Report
          
          **Repository:** ${context.repo.repo}
          **Branch:** ${context.ref}
          **Commit:** ${context.sha}
          **Environment:** ${{ needs.determine-environment.outputs.environment }}
          
          ### Failed Jobs
          - CI: ${{ needs.continuous-integration.result }}
          - Infrastructure: ${{ needs.deploy-infrastructure.result }}
          - Application: ${{ needs.deploy-application.result }}
          
          ### Next Steps
          1. Check workflow logs for detailed error information
          2. Verify Azure credentials and permissions
          3. Validate Bicep templates and parameters
          4. Fix issues and re-run deployment
          
          **Auto-generated by GitHub Actions**
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'deployment', 'high-priority']
          });