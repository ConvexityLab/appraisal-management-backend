/**
 * Communication API Test Script
 * Tests email, SMS, and Teams notification endpoints
 * Backend only sends messages - frontend handles template rendering
 * 
 * Usage: node scripts/test-communications.js
 */

const BASE_URL = 'http://localhost:3001';
// Use real JWT test token (generated by scripts/generate-test-token.js)
const AUTH_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXVzZXItYWRtaW4iLCJ1c2VySWQiOiJ0ZXN0LXVzZXItYWRtaW4iLCJlbWFpbCI6ImFkbWluQHRlc3QuY29tIiwibmFtZSI6IlRlc3QgQWRtaW4gVXNlciIsInJvbGUiOiJhZG1pbiIsInRlbmFudElkIjoidGVzdC10ZW5hbnQtMTIzIiwicGVybWlzc2lvbnMiOlsicmVhZCIsIndyaXRlIiwiYWRtaW4iXSwiaXNzIjoiYXBwcmFpc2FsLW1hbmFnZW1lbnQtdGVzdCIsImF1ZCI6ImFwcHJhaXNhbC1tYW5hZ2VtZW50LWFwaSIsImlhdCI6MTc3MDkyNjk0MSwiaXNUZXN0VG9rZW4iOnRydWUsImV4cCI6MTc3MzUxODk0MX0.3kPavGBoJTSnsU1FSh8g5CswlOK_Zkc7kmp8BahGnCA';
const testOrderId = `test-order-${Date.now()}`;

const results = { total: 0, passed: 0, failed: 0, tests: [] };

function recordTest(name, passed, message = '') {
  results.total++;
  if (passed) {
    results.passed++;
    console.log(`‚úÖ ${name}`);
  } else {
    results.failed++;
    console.log(`‚ùå ${name}`);
    if (message) console.log(`   Error: ${message}`);
  }
  results.tests.push({ name, passed, message });
}

async function testEmailPlainText() {
  console.log('\n=== Testing Email with HTML ===');
  
  try {
    const response = await fetch(`${BASE_URL}/api/communications/email`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${AUTH_TOKEN}`
      },
      body: JSON.stringify({
        orderId: testOrderId,
        to: 'test@example.com',
        subject: 'Test Email from Backend API',
        body: '<html><body><h1>Test Email</h1><p>This email body was rendered by the frontend and sent via backend API.</p></body></html>'
      })
    });

    const data = await response.json();
    
    if (response.ok && data.success) {
      recordTest('Send Email', true);
      console.log(`   Message ID: ${data.data.messageId}`);
      return data.data.messageId;
    } else {
      recordTest('Send Email', false, data.error || 'Unknown error');
      return null;
    }
  } catch (error) {
    recordTest('Send Email', false, error.message);
    return null;
  }
}

async function testSMS() {
  console.log('\n=== Testing SMS ===');
  
  try {
    const response = await fetch(`${BASE_URL}/api/communications/sms`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${AUTH_TOKEN}`
      },
      body: JSON.stringify({
        orderId: testOrderId,
        to: '+15551234567',
        body: 'Your property inspection is scheduled for tomorrow at 2:00 PM. Reply CONFIRM to acknowledge.'
      })
    });

    const data = await response.json();
    
    if (response.ok && data.success) {
      recordTest('Send SMS', true);
      console.log(`   Message ID: ${data.data.messageId}`);
      return data.data.messageId;
    } else {
      recordTest('Send SMS', false, data.error || 'Unknown error');
      console.log(`   Note: SMS may fail if Azure Communication Services is not configured`);
      return null;
    }
  } catch (error) {
    recordTest('Send SMS', false, error.message);
    return null;
  }
}

async function testTeamsNotification() {
  console.log('\n=== Testing Teams Notification ===');
  
  try {
    const response = await fetch(`${BASE_URL}/api/communications/teams`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${AUTH_TOKEN}`
      },
      body: JSON.stringify({
        orderId: testOrderId,
        teamId: process.env.TEAMS_TEST_TEAM_ID || 'test-team-id',
        channelId: process.env.TEAMS_TEST_CHANNEL_ID || 'test-channel-id',
        subject: 'üè† New Order Alert',
        body: `**Order ${testOrderId}** has been assigned.\n\n**Property:** 123 Main Street\n**Due Date:** 2026-02-20\n\n[View Order](${BASE_URL}/orders/${testOrderId})`
      })
    });

    const data = await response.json();
    
    if (response.ok && data.success) {
      recordTest('Send Teams Notification', true);
      console.log(`   Message ID: ${data.data.messageId}`);
      return data.data.messageId;
    } else {
      recordTest('Send Teams Notification', false, data.error || 'Unknown error');
      console.log(`   Note: Teams may fail if Microsoft Graph API is not configured`);
      return null;
    }
  } catch (error) {
    recordTest('Send Teams Notification', false, error.message);
    return null;
  }
}

async function testCommunicationHistory() {
  console.log('\n=== Testing Communication History ===');
  
  try {
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const response = await fetch(`${BASE_URL}/api/communications/history/${testOrderId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${AUTH_TOKEN}`
      }
    });

    const data = await response.json();
    
    if (response.ok && data.success) {
      const messageCount = data.data.messageCount;
      recordTest('Retrieve Communication History', true);
      console.log(`   Messages Retrieved: ${messageCount}`);
      
      if (messageCount > 0) {
        console.log('\n   Messages:');
        data.data.messages.forEach((msg, idx) => {
          console.log(`   ${idx + 1}. [${msg.channel.toUpperCase()}] ${msg.to} - ${msg.status}`);
        });
        recordTest('History Contains Messages', messageCount > 0);
      }
      
      return messageCount;
    } else {
      recordTest('Retrieve Communication History', false, data.error || 'Unknown error');
      return 0;
    }
  } catch (error) {
    recordTest('Retrieve Communication History', false, error.message);
    return 0;
  }
}

async function testValidation() {
  console.log('\n=== Testing Validation ===');
  
  try {
    const response = await fetch(`${BASE_URL}/api/communications/email`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${AUTH_TOKEN}`
      },
      body: JSON.stringify({
        orderId: testOrderId
        // Missing required fields
      })
    });

    const data = await response.json();
    
    if (response.status === 400 && !data.success) {
      recordTest('Email Validation', true);
      console.log(`   Correctly rejected invalid request`);
    } else {
      recordTest('Email Validation', false, 'Should have rejected invalid request');
    }
  } catch (error) {
    recordTest('Email Validation', false, error.message);
  }
}

async function runAllTests() {
  console.log('üöÄ Communication API Test Suite');
  console.log('================================\n');
  console.log(`Base URL: ${BASE_URL}`);
  console.log(`Test Order ID: ${testOrderId}\n`);

  await testEmailPlainText();
  await testSMS();
  await testTeamsNotification();
  await testValidation();
  await testCommunicationHistory();

  console.log('\n================================');
  console.log('üìä Test Summary');
  console.log('================================');
  console.log(`Total Tests: ${results.total}`);
  console.log(`Passed: ${results.passed} ‚úÖ`);
  console.log(`Failed: ${results.failed} ‚ùå`);
  console.log(`Success Rate: ${Math.round((results.passed / results.total) * 100)}%`);
  
  if (results.failed > 0) {
    console.log('\n‚ùå Failed Tests:');
    results.tests.filter(t => !t.passed).forEach(t => console.log(`   - ${t.name}: ${t.message}`));
  }

  console.log('\n‚úÖ Phase 4.1 Communication Test Complete!');
  process.exit(results.failed > 0 ? 1 : 0);
}

runAllTests().catch(error => {
  console.error('Fatal error:', error);
  process.exit(1);
});
